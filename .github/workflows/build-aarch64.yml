name: Build chan_quectel IPK aarch64

on:
  workflow_dispatch:
    inputs:
      asterisk_version:
        description: 'Asterisk version'
        required: true
        default: '20'
        type: choice
        options:
          - '18'
          - '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev zlib1g-dev gawk git wget tar gzip flex bison patch diffstat autoconf automake libtool

      - name: Download SDK
        run: |
          cd /tmp
          wget https://downloads.openwrt.org/releases/23.05.0/targets/rockchip/armv8/openwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar -xf *.tar.xz
          mv openwrt-sdk-* sdk
          echo "SDK_PATH=/tmp/sdk" >> $GITHUB_ENV

      - name: Build chan_quectel directly
        run: |
          cd $GITHUB_WORKSPACE
          
          ASTERISK_VER=${{ github.event.inputs.asterisk_version }}
          
          echo "=== Building chan_quectel directly ==="
          
          # Bootstrap and configure
          test -f bootstrap && ./bootstrap
          ./configure --with-astversion=$ASTERISK_VER
          
          # Show what we have
          echo "=== Files after configure ==="
          ls -la
          
          # Compile
          echo "=== Starting compilation ==="
          make -j$(nproc)
          
          # Show what was built
          echo "=== Files after build ==="
          find . -name "chan_quectel*" -type f
          ls -la chan_quectel.* 2>/dev/null || echo "Files not in root"

      - name: Copy compiled files
        run: |
          mkdir -p /tmp/ipk_out
          
          cd $GITHUB_WORKSPACE
          
          echo "=== Searching for compiled files ==="
          
          # Find chan_quectel.so
          find . -name "chan_quectel.so" -type f -exec ls -la {} \; -exec cp {} /tmp/ipk_out/ \;
          
          # Find other artifacts
          find . -name "chan_quectel.o" -type f -exec cp {} /tmp/ipk_out/ \;
          find . -name "chan_quectel*.la" -type f -exec cp {} /tmp/ipk_out/ \;
          
          # Check what we got
          echo "=== Files copied ==="
          ls -lah /tmp/ipk_out/
          
          if [ ! -f /tmp/ipk_out/chan_quectel.so ]; then
            echo "ERROR: chan_quectel.so not found!"
            echo "=== Complete directory listing ==="
            find $GITHUB_WORKSPACE -type f -name "*.so" -o -name "*.o" | head -30
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chan-quectel-compiled
          path: /tmp/ipk_out/
          retention-days: 7
