name: Build chan_quectel for aarch64_cortex-a53

on:
  workflow_dispatch:
    inputs:
      asterisk_version:
        description: 'Asterisk version'
        required: true
        default: '20'
        type: choice
        options:
          - '18'
          - '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar gzip build-essential libncurses-dev zlib1g-dev gawk git

      - name: Download OpenWrt SDK
        run: |
          cd /tmp
          wget https://downloads.openwrt.org/releases/23.05.0/targets/rockchip/armv8/openwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar -xf *.tar.xz
          cd openwrt-sdk-*
          echo "SDK_PATH=$(pwd)" >> $GITHUB_ENV

      - name: Prepare SDK
        run: |
          cd $SDK_PATH
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add chan_quectel
        run: |
          cd $SDK_PATH
          mkdir -p feeds/custom
          cp -r $GITHUB_WORKSPACE feeds/custom/chan_quectel
          ./scripts/feeds install chan_quectel asterisk${{ github.event.inputs.asterisk_version }} asterisk${{ github.event.inputs.asterisk_version }}-devel

      - name: Build chan_quectel
        run: |
          cd $SDK_PATH
          make package/feeds/custom/chan_quectel/compile -j$(nproc) V=sc

      - name: Prepare artifacts
        run: |
          mkdir -p /tmp/artifacts
          cd $SDK_PATH
          find bin/packages -name "*chan_quectel*.ipk" -exec cp {} /tmp/artifacts/ \;
          ls -lah /tmp/artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: chan-quectel-aarch64_cortex-a53
          path: /tmp/artifacts/
          retention-days: 7
