name: build-chan_quectel-ipk (aarch64_cortex-a53 / Asterisk 20)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget curl ca-certificates time xz-utils zstd

      - name: Download OpenWrt SDK (24.10.4 / mediatek-filogic)
        run: |
          set -eux
          SDK_URL="https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/filogic/openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          mkdir -p /tmp/openwrt-sdk
          cd /tmp/openwrt-sdk
          wget -O sdk.tar.zst "$SDK_URL"
          tar --use-compress-program=unzstd -xf sdk.tar.zst
          SDK_DIR="$(find . -maxdepth 1 -type d -name 'openwrt-sdk-*' | head -n1)"
          echo "SDK_DIR=/tmp/openwrt-sdk/${SDK_DIR#./}" >> "$GITHUB_ENV"

      - name: Update & install feeds
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add chan_quectel sources into SDK custom feed dir
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          rm -rf package/feeds/custom/chan_quectel
          mkdir -p package/feeds/custom/chan_quectel/src
          git clone --depth 1 https://github.com/IchthysMaranatha/asterisk-chan-quectel.git /tmp/chan_quectel_src
          rsync -a --delete /tmp/chan_quectel_src/ package/feeds/custom/chan_quectel/src/
          echo "=== src files (repo) ==="
          ls -la package/feeds/custom/chan_quectel/src | sed -n '1,200p'
          echo "=== find *.c (repo) ==="
          find package/feeds/custom/chan_quectel/src -maxdepth 3 -type f -name '*.c' -print || true

      - name: Write OpenWrt package Makefile (fix SRC find + link to libopenssl)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          python3 - <<'PY'
          from pathlib import Path

          mf = Path("package/feeds/custom/chan_quectel/Makefile")

          lines = [
            "include $(TOPDIR)/rules.mk",
            "",
            "PKG_NAME:=chan_quectel",
            "PKG_VERSION:=git",
            "PKG_RELEASE:=1",
            "",
            "PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)",
            "",
            "include $(INCLUDE_DIR)/package.mk",
            "",
            "define Package/chan_quectel",
            "  SECTION:=net",
            "  CATEGORY:=Network",
            "  SUBMENU:=Telephony",
            "  TITLE:=Asterisk channel driver for Quectel LTE modems",
            # ВАЖНО: для -lssl/-lcrypto нужен libopenssl (а не openssl tools)
            "  DEPENDS:=+asterisk20 +libopenssl +libiconv-full +alsa-lib +libusb-1.0",
            "endef",
            "",
            "define Package/chan_quectel/description",
            "  Asterisk channel driver (chan_quectel) for Quectel LTE modems.",
            "endef",
            "",
            "define Build/Prepare",
            "\t$(call Build/Prepare/Default)",
            "\t$(CP) ./src/* $(PKG_BUILD_DIR)/",
            "endef",
            "",
            "define Build/Compile",
            "\t@set -eux; \\",
            "\t  echo '=== build dir files ==='; \\",
            "\t  ls -la \"$(PKG_BUILD_DIR)\"; \\",
            "\t  echo '=== find *.c in build dir ==='; \\",
            "\t  find \"$(PKG_BUILD_DIR)\" -maxdepth 3 -type f -name '*.c' -print || true; \\",
            # Сначала ищем chan_quectel.c, если нет — любой .c
            "\t  SRC=\"$$(find \"$(PKG_BUILD_DIR)\" -maxdepth 3 -type f -name 'chan_quectel.c' -print -quit)\"; \\",
            "\t  if [ -z \"$$SRC\" ]; then SRC=\"$$(find \"$(PKG_BUILD_DIR)\" -maxdepth 3 -type f -name '*.c' -print -quit)\"; fi; \\",
            "\t  test -n \"$$SRC\"; \\",
            "\t  echo \"Building from $$SRC\"; \\",
            # Проверим, что libssl/libcrypto реально появились в staging
            "\t  echo '=== check openssl libs in staging ==='; \\",
            "\t  ls -la \"$(STAGING_DIR)/usr/lib\" | grep -E 'lib(ssl|crypto)\\.so' || true; \\",
            "\t  $(TARGET_CC) -shared -fPIC \\",
            "\t    $(TARGET_CFLAGS) $(EXTRA_CFLAGS) \\",
            "\t    -I$(STAGING_DIR)/usr/include \\",
            "\t    -I$(STAGING_DIR)/usr/include/asterisk \\",
            "\t    -I$(STAGING_DIR)/usr/include/libusb-1.0 \\",
            "\t    -o \"$(PKG_BUILD_DIR)/chan_quectel.so\" \"$$SRC\" \\",
            "\t    -L$(STAGING_DIR)/usr/lib -lusb-1.0 -lasound -lssl -lcrypto;",
            "endef",
            "",
            "define Package/chan_quectel/install",
            "\t$(INSTALL_DIR) $(1)/usr/lib/asterisk/modules",
            "\t$(INSTALL_BIN) $(PKG_BUILD_DIR)/chan_quectel.so $(1)/usr/lib/asterisk/modules/",
            "endef",
            "",
            "$(eval $(call BuildPackage,chan_quectel))",
            "",
          ]

          mf.write_text("\n".join(lines), encoding="utf-8")
          print("Wrote", mf)
          PY

          # страховка: CRLF -> LF и пробелы перед $(...) -> TAB
          MF="package/feeds/custom/chan_quectel/Makefile"
          sed -i 's/\r$//' "$MF"
          perl -pi -e 's/^ +(?=\$\()/\t/' "$MF"

          echo "=== Makefile (35..110) ==="
          nl -ba "$MF" | sed -n '35,110p'

      - name: Minimal .config (no menuconfig)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          cat > .config <<'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_generic=y

          CONFIG_PACKAGE_asterisk20=y
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_libiconv-full=y
          CONFIG_PACKAGE_alsa-lib=y
          CONFIG_PACKAGE_libusb-1.0=y
          CONFIG_PACKAGE_chan_quectel=y
          EOF
          make defconfig

      # ВАЖНО: сначала собираем зависимости, чтобы они попали в staging_dir
      - name: Build deps into staging (asterisk20 + libopenssl)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/feeds/telephony/asterisk20/compile -j"$(nproc)" V=s
          make package/feeds/packages/libopenssl/compile -j"$(nproc)" V=s

      - name: Build chan_quectel (IPK)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/feeds/custom/chan_quectel/compile -j"$(nproc)" V=s

      - name: Collect artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          mkdir -p /tmp/artifacts
          find bin/packages -type f -name "chan_quectel_*.ipk" -print -exec cp -v {} /tmp/artifacts/ \;
          find build_dir -type f -name "chan_quectel.so" -print -exec cp -v {} /tmp/artifacts/ \; || true
          echo "=== artifacts ==="
          ls -la /tmp/artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan_quectel-ipk-aarch64_cortex-a53
          path: /tmp/artifacts/*