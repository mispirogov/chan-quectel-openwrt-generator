name: Build chan_quectel for aarch64_cortex-a53

on:
  workflow_dispatch:
    inputs:
      asterisk_version:
        description: 'Asterisk version'
        required: true
        default: '20'
        type: choice
        options:
          - '18'
          - '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar gzip build-essential libncurses-dev zlib1g-dev gawk git autoconf automake libtool pkg-config

      - name: Download OpenWrt SDK
        run: |
          cd /tmp
          echo "Downloading SDK..."
          wget -q https://downloads.openwrt.org/releases/23.05.0/targets/rockchip/armv8/openwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          echo "Extracting SDK..."
          tar -xf *.tar.xz
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          echo "SDK_PATH=/tmp/$SDK_DIR" >> $GITHUB_ENV
          echo "SDK extracted to: /tmp/$SDK_DIR"

      - name: Install Asterisk development files
        run: |
          cd "$SDK_PATH"
          echo "Downloading Asterisk..."
          # Download pre-built Asterisk packages
          ASTERISK_VER=${{ github.event.inputs.asterisk_version }}
          
          mkdir -p asterisk-tmp
          cd asterisk-tmp
          
          # Download Asterisk package
          wget -q https://downloads.openwrt.org/releases/23.05.0/packages/aarch64_cortex-a53/telephony/asterisk${ASTERISK_VER}_*.ipk || \
          wget -q https://downloads.openwrt.org/snapshots/packages/aarch64_cortex-a53/telephony/asterisk${ASTERISK_VER}_*.ipk || \
          true
          
          echo "Asterisk packages:"
          ls -la asterisk*.ipk || echo "No IPK found, will compile without pre-built"

      - name: Compile chan_quectel directly
        run: |
          cd "$GITHUB_WORKSPACE"
          
          ASTERISK_VER=${{ github.event.inputs.asterisk_version }}
          
          echo "=== Compiling chan_quectel for Asterisk $ASTERISK_VER ==="
          
          # Ensure we have bootstrap
          if [ -f bootstrap ]; then
            ./bootstrap
          fi
          
          # Configure for compilation
          ./configure --with-astversion=$ASTERISK_VER \
                     --with-asterisk-includes=/tmp/asterisk-includes \
                     --with-asterisk-libs=/tmp/asterisk-libs || \
          ./configure --with-astversion=$ASTERISK_VER || true
          
          # Try to compile
          if [ -f Makefile ]; then
            make clean || true
            make -j$(nproc) || make -j1
          else
            echo "No Makefile found after configure"
            ls -la
          fi

      - name: Find and copy compiled module
        run: |
          mkdir -p /tmp/artifacts
          
          echo "=== Searching for compiled files ==="
          
          # Search in workspace
          find "$GITHUB_WORKSPACE" -type f \( -name "*.so" -o -name "*.o" -o -name "*.a" \) | head -20
          
          # Copy any .so files
          find "$GITHUB_WORKSPACE" -name "chan_quectel.so" -exec cp {} /tmp/artifacts/ \;
          find "$GITHUB_WORKSPACE" -name "chan_quectel*.o" -exec cp {} /tmp/artifacts/ \;
          
          # If nothing found, create a marker file
          if [ ! -f /tmp/artifacts/chan_quectel.so ]; then
            echo "WARNING: chan_quectel.so not found" > /tmp/artifacts/BUILD_INFO.txt
            echo "Searched in: $GITHUB_WORKSPACE" >> /tmp/artifacts/BUILD_INFO.txt
            find "$GITHUB_WORKSPACE" -type f -newer /tmp/BUILD_START 2>/dev/null | head -20 >> /tmp/artifacts/BUILD_INFO.txt || true
          fi
          
          echo "=== Artifacts ready ==="
          ls -lah /tmp/artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan-quectel-aarch64_cortex-a53
          path: /tmp/artifacts/
          retention-days: 7
