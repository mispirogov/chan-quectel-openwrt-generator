name: Build chan_quectel for aarch64_cortex-a53

on:
  workflow_dispatch:
    inputs:
      asterisk_version:
        description: 'Asterisk version'
        required: true
        default: '20'
        type: choice
        options:
          - '18'
          - '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar gzip build-essential libncurses-dev zlib1g-dev gawk git flex bison

      - name: Download OpenWrt SDK
        run: |
          cd /tmp
          wget -q https://downloads.openwrt.org/releases/23.05.0/targets/rockchip/armv8/openwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar -xf *.tar.xz
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          echo "SDK_PATH=/tmp/$SDK_DIR" >> $GITHUB_ENV

      - name: Setup SDK minimal
        run: |
          cd "$SDK_PATH"
          # Update only necessary feeds
          ./scripts/feeds update packages
          ./scripts/feeds install asterisk${{ github.event.inputs.asterisk_version }} asterisk${{ github.event.inputs.asterisk_version }}-devel libopenssl-devel

      - name: Add chan_quectel
        run: |
          cd "$SDK_PATH"
          mkdir -p feeds/custom
          cp -r $GITHUB_WORKSPACE feeds/custom/chan_quectel
          
          # Add custom feed to feeds.conf
          echo "src-git custom file://feeds/custom" >> feeds.conf.default
          
          # Install from custom feed
          ./scripts/feeds update custom
          ./scripts/feeds install -p custom chan_quectel

      - name: Build directly with make
        run: |
          cd "$SDK_PATH"
          # Build chan_quectel directly
          cd feeds/custom/chan_quectel
          
          # Check Asterisk version
          ASTERISK_VER=${{ github.event.inputs.asterisk_version }}
          
          # Compile
          make -f Makefile ASTERISK_VER=$ASTERISK_VER
          
          # If Makefile doesn't work, try autotools
          if [ ! -f Makefile ]; then
            ./bootstrap
            ./configure --with-astversion=$ASTERISK_VER
            make
          fi

      - name: Copy compiled module
        run: |
          mkdir -p /tmp/artifacts
          
          # Find the built .so file
          find "$SDK_PATH" -name "chan_quectel.so" -exec cp {} /tmp/artifacts/ \;
          
          # Also look for .o files
          find "$SDK_PATH" -path "*chan_quectel*.o" -exec cp {} /tmp/artifacts/ \;
          
          echo "=== Built files ==="
          ls -lah /tmp/artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan-quectel-aarch64_cortex-a53
          path: /tmp/artifacts/
          retention-days: 7
