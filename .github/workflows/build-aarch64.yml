name: build-chan_quectel-ipk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git wget curl rsync \
            libncurses-dev zlib1g-dev gettext \
            python3 unzip xz-utils zstd

      - name: Download OpenWrt SDK
        run: |
          set -eux
          mkdir -p /tmp/sdk
          cd /tmp/sdk
          wget -O sdk.tar.zst "https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/filogic/openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          tar --use-compress-program=unzstd -xf sdk.tar.zst
          SDK_DIR="$(find . -maxdepth 1 -type d -name 'openwrt-sdk-*' | head -n1)"
          echo "SDK_DIR=/tmp/sdk/${SDK_DIR#./}" >> "$GITHUB_ENV"

      - name: Update feeds
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add chan_quectel source
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          rm -rf package/feeds/custom/chan_quectel
          mkdir -p package/feeds/custom/chan_quectel/src
          git clone --depth 1 https://github.com/IchthysMaranatha/asterisk-chan-quectel.git /tmp/chan
          rsync -a --delete /tmp/chan/ package/feeds/custom/chan_quectel/src/

      - name: Write OpenWrt Makefile
        working-directory: ${{ env.SDK_DIR }}
        shell: bash
        run: |
          set -eux
          MF="package/feeds/custom/chan_quectel/Makefile"
          mkdir -p "$(dirname "$MF")"

          bash -lc 'cat > "'"$MF"'" <<-EOF
include \$(TOPDIR)/rules.mk

PKG_NAME:=chan_quectel
PKG_VERSION:=git
PKG_RELEASE:=1

PKG_BUILD_DIR:=\$(BUILD_DIR)/\$(PKG_NAME)

include \$(INCLUDE_DIR)/package.mk

define Package/chan_quectel
  SECTION:=net
  CATEGORY:=Network
  SUBMENU:=Telephony
  TITLE:=Asterisk channel driver for Quectel LTE modems
  DEPENDS:=+asterisk20 +asterisk20-dev +libopenssl +libiconv-full +alsa-lib +libusb-1.0
endef

define Package/chan_quectel/description
  Asterisk channel driver (chan_quectel) for Quectel LTE modems.
endef

define Build/Prepare
	\$(call Build/Prepare/Default)
	\$(CP) ./src/* \$(PKG_BUILD_DIR)/
endef

define Build/Compile
	@set -eux; \\
	test -f "\$(PKG_BUILD_DIR)/chan_quectel.c"; \\
	echo "Building chan_quectel.c"; \\
	\$(TARGET_CC) -shared -fPIC \\
	  \$(TARGET_CFLAGS) \\
	  -I\$(STAGING_DIR)/usr/include \\
	  -I\$(STAGING_DIR)/usr/include/asterisk \\
	  -I\$(STAGING_DIR)/usr/include/libusb-1.0 \\
	  -o "\$(PKG_BUILD_DIR)/chan_quectel.so" \\
	  "\$(PKG_BUILD_DIR)/chan_quectel.c" \\
	  -L\$(STAGING_DIR)/usr/lib \\
	  -lusb-1.0 -lasound -lssl -lcrypto
endef

define Package/chan_quectel/install
	\$(INSTALL_DIR) \$(1)/usr/lib/asterisk/modules
	\$(INSTALL_BIN) \$(PKG_BUILD_DIR)/chan_quectel.so \\
		\$(1)/usr/lib/asterisk/modules/
endef

\$(eval \$(call BuildPackage,chan_quectel))
EOF'

          sed -i 's/\r$//' "$MF"
          echo "=== Makefile preview ==="
          nl -ba "$MF" | sed -n '1,140p'

      - name: Minimal config
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          cat > .config <<'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_generic=y

CONFIG_PACKAGE_asterisk20=y
CONFIG_PACKAGE_asterisk20-dev=y
CONFIG_PACKAGE_libopenssl=y
CONFIG_PACKAGE_libiconv-full=y
CONFIG_PACKAGE_alsa-lib=y
CONFIG_PACKAGE_libusb-1.0=y
CONFIG_PACKAGE_chan_quectel=y
EOF
          make defconfig

      - name: Build chan_quectel
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/feeds/custom/chan_quectel/compile -j"$(nproc)" V=s

      - name: Collect artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          mkdir -p /tmp/artifacts
          find bin/packages -type f -name "chan_quectel_*.ipk" -exec cp -v {} /tmp/artifacts/ \;
          find build_dir -type f -name "chan_quectel.so" -exec cp -v {} /tmp/artifacts/ \; || true
          ls -la /tmp/artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan_quectel-ipk
          path: /tmp/artifacts/*