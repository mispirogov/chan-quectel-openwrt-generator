name: build-chan_quectel-ipk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            wget \
            curl \
            rsync \
            libncurses-dev \
            zlib1g-dev \
            gettext \
            python3 \
            unzip \
            xz-utils \
            zstd

      - name: Download OpenWrt SDK 24.10.4 (mediatek filogic)
        run: |
          set -eux
          mkdir -p /tmp/sdk
          cd /tmp/sdk

          wget -O sdk.tar.zst \
            https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/filogic/openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          tar --use-compress-program=unzstd -xf sdk.tar.zst

          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n1)
          echo "SDK_DIR=/tmp/sdk/${SDK_DIR#./}" >> "$GITHUB_ENV"

      - name: Update and install feeds
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Detect asterisk package directory in package/feeds (deep search)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux

          # Ищем именно Makefile пакета, а не каталог (так надёжнее).
          # Сначала пытаемся asterisk20 (если вдруг есть), иначе обычный asterisk.
          AST_MK20=$(find package/feeds -type f -path '*/asterisk20/Makefile' 2>/dev/null | head -n1 || true)
          AST_MK=$(find package/feeds -type f -path '*/asterisk/Makefile' 2>/dev/null | head -n1 || true)

          if [ -n "$AST_MK20" ]; then
            AST_MK="$AST_MK20"
          fi

          if [ -z "$AST_MK" ]; then
            echo "ERROR: cannot find */asterisk/Makefile (or asterisk20) under package/feeds"
            find package/feeds -type f -path '*asterisk*/Makefile' | sed -n '1,120p' || true
            exit 1
          fi

          AST_DIR=$(dirname "$AST_MK")
          AST_PKG=$(basename "$AST_DIR")

          echo "AST_MK=$AST_MK" >> "$GITHUB_ENV"
          echo "AST_DIR=$AST_DIR" >> "$GITHUB_ENV"
          echo "AST_PKG=$AST_PKG" >> "$GITHUB_ENV"

          echo "Using AST_MK=$AST_MK"
          echo "Using AST_DIR=$AST_DIR"
          echo "Using AST_PKG=$AST_PKG"

      - name: Add chan_quectel source
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          rm -rf package/feeds/custom/chan_quectel
          mkdir -p package/feeds/custom/chan_quectel/src

          git clone --depth 1 \
            https://github.com/IchthysMaranatha/asterisk-chan-quectel.git \
            /tmp/chan

          rsync -a --delete \
            /tmp/chan/ \
            package/feeds/custom/chan_quectel/src/

      - name: Write OpenWrt package Makefile (no heredoc)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux

          MF=package/feeds/custom/chan_quectel/Makefile
          mkdir -p package/feeds/custom/chan_quectel

          # Важно: рецепты пишем с 4 пробелами в начале, потом конвертируем их в TAB.
          printf '%s\n' \
            'include $(TOPDIR)/rules.mk' \
            '' \
            'PKG_NAME:=chan_quectel' \
            'PKG_VERSION:=git' \
            'PKG_RELEASE:=1' \
            '' \
            'PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)' \
            '' \
            'include $(INCLUDE_DIR)/package.mk' \
            '' \
            'define Package/chan_quectel' \
            '  SECTION:=net' \
            '  CATEGORY:=Network' \
            '  SUBMENU:=Telephony' \
            '  TITLE:=Asterisk channel driver for Quectel LTE modems' \
            "  DEPENDS:=+${AST_PKG} +libopenssl +libiconv-full +alsa-lib +libusb-1.0" \
            'endef' \
            '' \
            'define Package/chan_quectel/description' \
            '  Asterisk channel driver (chan_quectel) for Quectel LTE modems.' \
            'endef' \
            '' \
            'define Build/Prepare' \
            '    $(call Build/Prepare/Default)' \
            '    $(CP) ./src/* $(PKG_BUILD_DIR)/' \
            'endef' \
            '' \
            'define Build/Compile' \
            '    @set -eux;' \
            '    test -f "$(PKG_BUILD_DIR)/chan_quectel.c"' \
            '    echo "Building $(PKG_BUILD_DIR)/chan_quectel.c"' \
            '    $(TARGET_CC) -shared -fPIC' \
            '      $(TARGET_CFLAGS) $(EXTRA_CFLAGS)' \
            '      -I$(STAGING_DIR)/usr/include' \
            '      -I$(STAGING_DIR)/usr/include/asterisk' \
            '      -I$(STAGING_DIR)/usr/include/libusb-1.0' \
            '      -o "$(PKG_BUILD_DIR)/chan_quectel.so" "$(PKG_BUILD_DIR)/chan_quectel.c"' \
            '      -L$(STAGING_DIR)/usr/lib -lusb-1.0 -lasound -lssl -lcrypto' \
            'endef' \
            '' \
            'define Package/chan_quectel/install' \
            '    $(INSTALL_DIR) $(1)/usr/lib/asterisk/modules' \
            '    $(INSTALL_BIN) $(PKG_BUILD_DIR)/chan_quectel.so $(1)/usr/lib/asterisk/modules/' \
            'endef' \
            '' \
            '$(eval $(call BuildPackage,chan_quectel))' \
            > "$MF"

          # Конвертируем 4 пробела в TAB только для строк рецептов (где начинается команда)
          perl -pi -e 's/^ {4}(?=\$|@)/\t/' "$MF"
          sed -i 's/\r$//' "$MF"

          echo "=== Makefile preview ==="
          nl -ba "$MF" | sed -n '1,160p'

      - name: Create minimal .config
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux

          CFG=".config"
          : > "$CFG"

          printf '%s\n' \
            'CONFIG_TARGET_mediatek=y' \
            'CONFIG_TARGET_mediatek_filogic=y' \
            'CONFIG_TARGET_mediatek_filogic_DEVICE_generic=y' \
            '' \
            "CONFIG_PACKAGE_${AST_PKG}=y" \
            'CONFIG_PACKAGE_libopenssl=y' \
            'CONFIG_PACKAGE_libiconv-full=y' \
            'CONFIG_PACKAGE_alsa-lib=y' \
            'CONFIG_PACKAGE_libusb-1.0=y' \
            'CONFIG_PACKAGE_chan_quectel=y' \
            >> "$CFG"

          echo "=== .config ==="
          cat "$CFG"

          make defconfig

      - name: Build Asterisk first (populate staging headers)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          echo "Building Asterisk via: make ${AST_DIR}/compile"
          make "${AST_DIR}/compile" -j"$(nproc)" V=s

          echo "=== search asterisk.h in staging_dir ==="
          find staging_dir -type f -name 'asterisk.h' -print | sed -n '1,50p' || true

          echo "=== list include/asterisk (if exists) ==="
          ls -la staging_dir/target-aarch64_cortex-a53_musl/usr/include/asterisk || true

      - name: Build chan_quectel
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/feeds/custom/chan_quectel/compile -j"$(nproc)" V=s

      - name: Collect artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          mkdir -p /tmp/artifacts
          find bin/packages -type f -name "chan_quectel_*.ipk" -exec cp -v {} /tmp/artifacts/ \; || true
          find build_dir -type f -name "chan_quectel.so" -exec cp -v {} /tmp/artifacts/ \; || true
          echo "=== artifacts ==="
          ls -la /tmp/artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan_quectel-ipk
          path: /tmp/artifacts/*