name: build-chan_quectel-ipk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            wget \
            curl \
            rsync \
            libncurses-dev \
            zlib1g-dev \
            gettext \
            python3 \
            unzip \
            xz-utils \
            zstd

      - name: Download OpenWrt SDK 24.10.4 (mediatek filogic)
        run: |
          set -eux
          mkdir -p /tmp/sdk
          cd /tmp/sdk
          wget -O sdk.tar.zst https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/filogic/openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar --use-compress-program=unzstd -xf sdk.tar.zst
          SDK_DIR="$(find . -maxdepth 1 -type d -name 'openwrt-sdk-*' | head -n1)"
          echo "SDK_DIR=/tmp/sdk/${SDK_DIR#./}" >> "$GITHUB_ENV"

      - name: Add telephony feed + update/install feeds
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          if ! grep -qE '^\s*src-git\s+telephony\s+' feeds.conf.default; then
            echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10" >> feeds.conf.default
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          test -f feeds/telephony/net/asterisk/Makefile

      - name: Link asterisk as package/asterisk + compute ASTERISK_VERSION_NUM (no heredoc)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux

          AST_SRC="${PWD}/feeds/telephony/net/asterisk"
          test -f "${AST_SRC}/Makefile"

          ln -sfn "${AST_SRC}" package/asterisk
          test -f package/asterisk/Makefile

          AST_VER="$(sed -nE 's/^PKG_VERSION:=//p' package/asterisk/Makefile | head -n1 || true)"
          AST_VER="${AST_VER%%[^0-9.]*}"
          if [ -z "$AST_VER" ]; then
            AST_VER="20.0.0"
          fi

          OLDIFS="$IFS"
          IFS='.'
          set -- $AST_VER
          IFS="$OLDIFS"

          MA="${1:-0}"
          MI="${2:-0}"
          PA="${3:-0}"

          ASTERISK_VERSION_NUM="$(printf '%d%02d%02d' "$MA" "$MI" "$PA" | sed -E 's/^0+//')"
          if [ -z "$ASTERISK_VERSION_NUM" ]; then
            ASTERISK_VERSION_NUM="0"
          fi

          echo "ASTERISK_VER=$AST_VER" >> "$GITHUB_ENV"
          echo "ASTERISK_VERSION_NUM=$ASTERISK_VERSION_NUM" >> "$GITHUB_ENV"

          echo "Asterisk PKG_VERSION=$AST_VER"
          echo "Computed ASTERISK_VERSION_NUM=$ASTERISK_VERSION_NUM"

      - name: Minimal .config (build asterisk first)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          CFG=".config"
          : > "$CFG"
          printf '%s\n' \
            'CONFIG_TARGET_mediatek=y' \
            'CONFIG_TARGET_mediatek_filogic=y' \
            'CONFIG_TARGET_mediatek_filogic_DEVICE_generic=y' \
            '' \
            'CONFIG_PACKAGE_asterisk=y' \
            'CONFIG_PACKAGE_libopenssl=y' \
            'CONFIG_PACKAGE_libiconv-full=y' \
            'CONFIG_PACKAGE_alsa-lib=y' \
            'CONFIG_PACKAGE_libusb-1.0=y' \
            >> "$CFG"
          make defconfig

      - name: Build Asterisk first (populate staging headers)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/asterisk/compile -j"$(nproc)" V=s

      - name: Add chan_quectel source
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          rm -rf package/feeds/custom/chan_quectel
          mkdir -p package/feeds/custom/chan_quectel/src
          git clone --depth 1 https://github.com/IchthysMaranatha/asterisk-chan-quectel.git /tmp/chan
          rsync -a --delete /tmp/chan/ package/feeds/custom/chan_quectel/src/

      - name: Write chan_quectel OpenWrt package Makefile (no heredoc, fixed EXTRA_CFLAGS order)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux

          MF="package/feeds/custom/chan_quectel/Makefile"
          mkdir -p package/feeds/custom/chan_quectel

          # Все флаги одной строкой (чтобы ничего не "съедалось" make'ом и не ломалось переносами)
          # Порядок: disable fortify -> feature macros -> system includes -> asterisk autoconfig/compiler -> module defs
          EXTRA_FLAGS='-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0 -D_GNU_SOURCE -D_DEFAULT_SOURCE -D_BSD_SOURCE -D_POSIX_C_SOURCE=200809L -D_XOPEN_SOURCE=700 -D__MUSL__ -include sys/types.h -include sys/socket.h -include netinet/in.h -include arpa/inet.h -include stdio.h -include string.h -include time.h -include $(STAGING_DIR)/usr/include/asterisk/autoconfig.h -include $(STAGING_DIR)/usr/include/asterisk/compiler.h -DASTERISK_VERSION_NUM='"${ASTERISK_VERSION_NUM}"' -DAST_MODULE_SELF_SYM=__internal_asterisk_module_self -DAST_MODULE=\"chan_quectel\"'

          printf '%s\n' \
            'include $(TOPDIR)/rules.mk' \
            '' \
            'PKG_NAME:=chan_quectel' \
            'PKG_VERSION:=git' \
            'PKG_RELEASE:=1' \
            '' \
            'PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)' \
            'PKG_BUILD_DEPENDS:=asterisk' \
            '' \
            'include $(INCLUDE_DIR)/package.mk' \
            '' \
            'define Package/chan_quectel' \
            '  SECTION:=net' \
            '  CATEGORY:=Network' \
            '  SUBMENU:=Telephony' \
            '  TITLE:=Asterisk channel driver for Quectel LTE modems' \
            '  DEPENDS:=+asterisk +libopenssl +libiconv-full +alsa-lib +libusb-1.0' \
            'endef' \
            '' \
            'define Package/chan_quectel/description' \
            '  Asterisk channel driver (chan_quectel) for Quectel LTE modems.' \
            'endef' \
            '' \
            "EXTRA_CFLAGS += ${EXTRA_FLAGS}" \
            '' \
            'define Build/Prepare' \
            '    $(INSTALL_DIR) $(PKG_BUILD_DIR)' \
            '    $(CP) ./src/* $(PKG_BUILD_DIR)/' \
            'endef' \
            '' \
            'define Build/Compile' \
            '    @set -eux; test -f "$(PKG_BUILD_DIR)/chan_quectel.c"; echo "Compiling chan_quectel.c"; $(TARGET_CC) -shared -fPIC $(TARGET_CPPFLAGS) $(TARGET_CFLAGS) $(EXTRA_CFLAGS) -I$(STAGING_DIR)/usr/include -I$(STAGING_DIR)/usr/include/asterisk -I$(STAGING_DIR)/usr/include/libusb-1.0 -o "$(PKG_BUILD_DIR)/chan_quectel.so" "$(PKG_BUILD_DIR)/chan_quectel.c" -L$(STAGING_DIR)/usr/lib -lusb-1.0 -lasound -lssl -lcrypto' \
            'endef' \
            '' \
            'define Package/chan_quectel/install' \
            '    $(INSTALL_DIR) $(1)/usr/lib/asterisk/modules' \
            '    $(INSTALL_BIN) $(PKG_BUILD_DIR)/chan_quectel.so $(1)/usr/lib/asterisk/modules/' \
            'endef' \
            '' \
            '$(eval $(call BuildPackage,chan_quectel))' \
            > "$MF"

          perl -pi -e 's/^ {4}/\t/' "$MF"
          sed -i 's/\r$//' "$MF"

          echo "=== Generated chan_quectel Makefile preview ==="
          nl -ba "$MF" | sed -n '1,220p'

      - name: Enable chan_quectel in .config and defconfig
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          printf '%s\n' 'CONFIG_PACKAGE_chan_quectel=y' >> .config
          make defconfig

      - name: Build chan_quectel
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          make package/feeds/custom/chan_quectel/compile -j"$(nproc)" V=s

      - name: Collect artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -eux
          mkdir -p /tmp/artifacts
          find bin/packages -type f -name "chan_quectel_*.ipk" -exec cp -v {} /tmp/artifacts/ \; || true
          find build_dir -type f -name "chan_quectel.so" -exec cp -v {} /tmp/artifacts/ \; || true
          ls -la /tmp/artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chan_quectel-ipk
          path: /tmp/artifacts/*